{"version":3,"file":"Teleman.mjs","sources":["../src/index.mjs"],"sourcesContent":["import compose from 'koa-compose'\n\nfunction createURLSearchParams(query) {\n  if (query.constructor === String) {\n    return new URLSearchParams(query)\n  }\n\n  if (query.constructor === Object) {\n    query = Object.entries(query)\n  }\n\n  const q = new URLSearchParams()\n\n  for (const [name, value] of query) {\n    if (value != null) q.append(name, value)\n  }\n\n  return q\n}\n\nfunction createFormData(data) {\n  if (data.constructor === Object) {\n    data = Object.entries(data)\n  }\n\n  const f = new FormData()\n\n  for (const [name, value, filename] of data) {\n    if (value != null) f.append(name, value, filename)\n  }\n\n  return f\n}\n\nclass Teleman {\n  constructor({ base, headers, readBody = true, throwFailedResponse = true } = {}) {\n    if (base) {\n      this.base = base\n    } else {\n      try {\n        // defaults to document.baseURI in browser\n        this.base = document.baseURI\n      } catch (e) {\n        // in node.js, ignore\n      }\n    }\n\n    this.headers = headers\n    this.readBody = readBody\n    this.throwFailedResponse = throwFailedResponse\n    this.middleware = []\n  }\n\n  use(middleware, beginning = false) {\n    if (beginning) {\n      this.middleware.unshift(middleware)\n    } else {\n      this.middleware.push(middleware)\n    }\n  }\n\n  fetch(url, {\n    method = 'GET',\n    base = this.base,\n    headers,\n    query,\n    params = {},\n    body,\n    readBody = this.readBody,\n    throwFailedResponse = this.throwFailedResponse,\n    use = this.middleware,\n    useBefore = [],\n    useAfter = [],\n    ...rest } = {}\n  ) {\n    return new Promise(resolve => {\n      method = method.toUpperCase()\n      url = new URL(url.replace(/:([a-z]\\w*)/ig, (_, w) => encodeURIComponent(params[w])), base)\n\n      if (query) {\n        if (!(query instanceof URLSearchParams)) {\n          query = createURLSearchParams(query)\n        }\n\n        for (const [name, value] of query.entries()) {\n          url.searchParams.append(name, value)\n        }\n      }\n\n      if (this.headers && headers) {\n        const h = new Headers(this.headers)\n        for (const [name, value] of new Headers(headers).entries()) {\n          h.set(name, value)\n        }\n        headers = h\n      } else {\n        headers = new Headers(this.headers || headers || {})\n      }\n\n      if (body !== undefined && !['GET', 'HEAD'].includes(method)) {\n        const contentType = headers.get('Content-Type') || ''\n\n        if ((!contentType && body && body.constructor === Object) || contentType.startsWith('application/json')) {\n          if (!headers.has('Content-Type')) {\n            headers.set('Content-Type', 'application/json')\n          }\n\n          body = JSON.stringify(body)\n        } else if (contentType.startsWith('multipart/form-data') && body && !(body instanceof FormData)) {\n          body = createFormData(body)\n        } else if (contentType.startsWith('application/x-www-form-urlencoded') && body && !(body instanceof URLSearchParams)) {\n          body = createURLSearchParams(body)\n        }\n      }\n\n      const ctx = {\n        url,\n        options: { method, headers, body },\n        readBody,\n        ...rest\n      }\n\n      resolve(compose([...useBefore, ...use, ...useAfter])(ctx, () =>\n        fetch(ctx.url.href, ctx.options).then(response => {\n          ctx.response = response\n\n          let body = Promise.resolve()\n\n          if (readBody && ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'].includes(ctx.options.method.toUpperCase())) {\n            const responseType = response.headers.get('Content-Type')\n\n            if (responseType) {\n              if (responseType.startsWith('application/json')) {\n                body = response.json()\n              } else if (responseType.startsWith('text/')) {\n                body = response.text()\n              } else if (responseType.startsWith('multipart/form-data')) {\n                body = response.formData()\n              }\n            }\n          }\n\n          if (response.ok || !throwFailedResponse) {\n            return body\n          } else {\n            return body.then(e => { throw e })\n          }\n        })\n      ))\n    })\n  }\n\n  get(url, query, options) {\n    return this.fetch(url, {\n      method: 'GET',\n      query,\n      ...options\n    })\n  }\n\n  post(url, body, options) {\n    return this.fetch(url, {\n      method: 'POST',\n      body,\n      ...options\n    })\n  }\n\n  put(url, body, options) {\n    return this.fetch(url, {\n      method: 'PUT',\n      body,\n      ...options\n    })\n  }\n\n  patch(url, body, options) {\n    return this.fetch(url, {\n      method: 'PATCH',\n      body,\n      ...options\n    })\n  }\n\n  delete(url, query, options) {\n    return this.fetch(url, {\n      method: 'DELETE',\n      query,\n      ...options\n    })\n  }\n\n  head(url, query, options) {\n    return this.fetch(url, {\n      method: 'HEAD',\n      query,\n      ...options\n    })\n  }\n}\n\nconst singleton = Teleman.singleton = new Teleman()\nTeleman.use = singleton.use.bind(singleton)\nTeleman.fetch = singleton.fetch.bind(singleton)\nTeleman.get = singleton.get.bind(singleton)\nTeleman.post = singleton.post.bind(singleton)\nTeleman.put = singleton.put.bind(singleton)\nTeleman.patch = singleton.patch.bind(singleton)\nTeleman.delete = singleton.delete.bind(singleton)\nTeleman.head = singleton.head.bind(singleton)\n\nexport default Teleman\n"],"names":["createURLSearchParams","query","constructor","String","URLSearchParams","Object","entries","q","name","value","append","createFormData","data","f","FormData","filename","Teleman","base","headers","readBody","throwFailedResponse","document","baseURI","e","middleware","use","beginning","unshift","push","fetch","url","method","params","body","useBefore","useAfter","rest","Promise","resolve","toUpperCase","URL","replace","_","w","encodeURIComponent","searchParams","h","Headers","set","undefined","includes","contentType","get","startsWith","has","JSON","stringify","ctx","options","compose","href","then","response","responseType","json","text","formData","ok","post","put","patch","delete","head","singleton","bind"],"mappings":"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"}