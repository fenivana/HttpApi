{"version":3,"file":"Teleman.js","sources":["../src/index.mjs"],"sourcesContent":["import compose from 'koa-compose'\n\nfunction createURLSearchParams(query) {\n  if (query.constructor === String) {\n    return new URLSearchParams(query)\n  }\n\n  if (query.constructor === Object) {\n    query = Object.entries(query)\n  }\n\n  const q = new URLSearchParams()\n\n  for (const [name, value] of query) {\n    if (value != null) {\n      q.append(name, value)\n    }\n  }\n\n  return q\n}\n\nfunction createFormData(data) {\n  if (data.constructor === Object) {\n    data = Object.entries(data)\n  }\n\n  const f = new FormData()\n\n  for (const [name, value, filename] of data) {\n    if (value != null) {\n      f.append(name, value, filename)\n    }\n  }\n\n  return f\n}\n\nclass Teleman {\n  constructor({ base, headers, readBody = true, throwFailedResponse = true } = {}) {\n    if (base) {\n      this.base = base\n    } else {\n      try {\n        // defaults to document.baseURI in browser\n        this.base = document.baseURI\n      } catch (e) {\n        // in node.js, ignore\n      }\n    }\n\n    this.headers = headers\n    this.readBody = readBody\n    this.throwFailedResponse = throwFailedResponse\n    this.middleware = []\n  }\n\n  use(middleware, beginning = false) {\n    if (beginning) {\n      this.middleware.unshift(middleware)\n    } else {\n      this.middleware.push(middleware)\n    }\n  }\n\n  fetch(url, {\n    method = 'GET',\n    base = this.base,\n    headers,\n    query,\n    params = {},\n    body,\n    readBody = this.readBody,\n    throwFailedResponse = this.throwFailedResponse,\n    use = this.middleware,\n    useBefore = [],\n    useAfter = [],\n    ...rest } = {}\n  ) {\n    return new Promise(resolve => {\n      method = method.toUpperCase()\n      url = new URL(url.replace(/:([a-z]\\w*)/ig, (_, w) => encodeURIComponent(params[w])), base)\n\n      if (query) {\n        if (!(query instanceof URLSearchParams)) {\n          query = createURLSearchParams(query)\n        }\n\n        query.forEach((value, name) => url.searchParams.append(name, value))\n      }\n\n      if (this.headers && headers) {\n        const h = new Headers(this.headers)\n        new Headers(headers).forEach((value, name) => h.set(name, value))\n        headers = h\n      } else {\n        headers = new Headers(this.headers || headers || {})\n      }\n\n      if (body !== undefined && !['GET', 'HEAD'].includes(method)) {\n        const contentType = headers.get('Content-Type') || ''\n\n        if ((!contentType && body && body.constructor === Object) || contentType.startsWith('application/json')) {\n          if (!headers.has('Content-Type')) {\n            headers.set('Content-Type', 'application/json')\n          }\n\n          body = JSON.stringify(body)\n        } else if (contentType.startsWith('multipart/form-data') && body && !(body instanceof FormData)) {\n          body = createFormData(body)\n        } else if (contentType.startsWith('application/x-www-form-urlencoded') && body && !(body instanceof URLSearchParams)) {\n          body = createURLSearchParams(body)\n        }\n      }\n\n      const ctx = {\n        url,\n        options: { method, headers, body },\n        readBody,\n        ...rest\n      }\n\n      resolve(compose([...useBefore, ...use, ...useAfter])(ctx, () =>\n        fetch(ctx.url.href, ctx.options).then(response => {\n          ctx.response = response\n\n          let body = Promise.resolve()\n\n          if (readBody && ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'].includes(ctx.options.method.toUpperCase())) {\n            const responseType = response.headers.get('Content-Type')\n\n            if (responseType) {\n              if (responseType.startsWith('application/json')) {\n                body = response.json()\n              } else if (responseType.startsWith('text/')) {\n                body = response.text()\n              } else if (responseType.startsWith('multipart/form-data')) {\n                body = response.formData()\n              }\n            }\n          }\n\n          if (response.ok || !throwFailedResponse) {\n            return body\n          } else {\n            return body.then(e => { throw e })\n          }\n        })\n      ))\n    })\n  }\n\n  get(url, query, options) {\n    return this.fetch(url, {\n      method: 'GET',\n      query,\n      ...options\n    })\n  }\n\n  post(url, body, options) {\n    return this.fetch(url, {\n      method: 'POST',\n      body,\n      ...options\n    })\n  }\n\n  put(url, body, options) {\n    return this.fetch(url, {\n      method: 'PUT',\n      body,\n      ...options\n    })\n  }\n\n  patch(url, body, options) {\n    return this.fetch(url, {\n      method: 'PATCH',\n      body,\n      ...options\n    })\n  }\n\n  delete(url, query, options) {\n    return this.fetch(url, {\n      method: 'DELETE',\n      query,\n      ...options\n    })\n  }\n\n  head(url, query, options) {\n    return this.fetch(url, {\n      method: 'HEAD',\n      query,\n      ...options\n    })\n  }\n}\n\nconst singleton = Teleman.singleton = new Teleman()\nTeleman.use = singleton.use.bind(singleton)\nTeleman.fetch = singleton.fetch.bind(singleton)\nTeleman.get = singleton.get.bind(singleton)\nTeleman.post = singleton.post.bind(singleton)\nTeleman.put = singleton.put.bind(singleton)\nTeleman.patch = singleton.patch.bind(singleton)\nTeleman.delete = singleton.delete.bind(singleton)\nTeleman.head = singleton.head.bind(singleton)\n\nexport default Teleman\n"],"names":[],"mappings":"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"}